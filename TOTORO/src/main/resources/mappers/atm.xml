<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.sist.totoro.mappers.atm">
    
    <sql id="allColumns">
    	dwSeq,   
		userId,  
		dePoint, 
		wiPoint,
		dwPs,
		TO_CHAR(dwReqday,'YYYY-MM-DD HH24:MI:SS') dwReqday,
		TO_CHAR(dwGetday,'YYYY-MM-DD HH24:MI:SS') dwGetday    
    </sql>
    
    <!-- 출금 컬럼 -->
    <sql id="withdrawColumns">
    	dwSeq,   
		userId,  
		wiPoint,
		dwPs,
		TO_CHAR(dwReqday,'YYYY-MM-DD HH24:MI:SS') dwReqday,
		TO_CHAR(dwGetday,'YYYY-MM-DD HH24:MI:SS') dwGetday    
    </sql>
    
    
    <!-- 임금 컬럼 -->
    <sql id="depositColumns">
    	dwSeq,   
		userId,  
		dePoint, 
		dwPs,
		TO_CHAR(dwReqday,'YYYY-MM-DD HH24:MI:SS') dwReqday,
		TO_CHAR(dwGetday,'YYYY-MM-DD HH24:MI:SS') dwGetday    
    </sql>
    
    <sql id="baseCondition">
	    <where>
	    	<choose>
	    		<when test="'10'==search_div">
	    		    hr.userId like  #{search_word}||'%'
	    		</when>
	    		<when test="'20'==search_div">
	    		    hr.dwPs like  #{search_word}||'%'
	    		</when>
	    		<when test="'30'==search_div">
	    		    hr.email like  #{search_word}||'%'
	    		</when>		    		
	    		<otherwise></otherwise>
	    	</choose>
	    </where>     
    </sql>
    
    <!-- select list -->
    <select id="do_retrieve" 
      parameterType="SearchVO"
      resultType="AtmVo"  >
		SELECT X.*,Y.*
		  FROM(
		SELECT T.dwSeq,                                  
				T.userId,                                  
				T.dePoint,                              
				T.wiPoint,                               
				T.dwPs,                                 
				TO_CHAR(T.dwReqday,'YYYY-MM-DD') dwReqday,                             
				TO_CHAR(T.dwGetday,'YYYY-MM-DD') dwGetday,                                   
				T.rnum AS no                             
		  FROM(                                          
			SELECT dw.*                                  
				  ,ROW_NUMBER() OVER(ORDER BY dwReqday desc ) AS rnum       
			  FROM dw_record dw
             <include refid="baseCondition"/>
		  )T
		  WHERE rnum BETWEEN (#{page_size} * (#{page_num}-1)+1) 
		    AND (#{page_size} * (#{page_num}-1)+#{page_size})
		)X    
		NATURAL JOIN
		(
		  SELECT COUNT(*) AS total_cnt   
		    FROM dw_record
		    <include refid="baseCondition"/>
		)Y      
    </select>
    
    
    <!-- 관리자 입금 요청 전체 조회 -->
    <select id="adReqDeAll" resultType="AtmVo">   		
    	SELECT X.*,Y.*
		  FROM(
		SELECT T.dwSeq,                                  
				T.userId,                                  
				T.dePoint,                                                             
				T.dwPs,                                 
				TO_CHAR(T.dwReqday,'YYYY-MM-DD') dwReqday,                             
				TO_CHAR(T.dwGetday,'YYYY-MM-DD') dwGetday,                                   
				T.rnum AS no                             
		  FROM(                                          
			SELECT dw.*                                  
				  ,ROW_NUMBER() OVER(ORDER BY dwReqday desc ) AS rnum       
			  FROM dw_record dw
		  )T
		  WHERE rnum BETWEEN (#{page_size} * (#{page_num}-1)+1) 
		    AND (#{page_size} * (#{page_num}-1)+#{page_size})
		)X    
		NATURAL JOIN
		(
		  SELECT COUNT(*) AS total_cnt   
		    FROM dw_record
		)Y
		WHERE dwPs=0
    	AND dePoint IS NOT NULL      	
    </select>
    
     <!-- 관리자 출금 요청 전체 조회 -->
    <select id="adReqWiAll" resultType="AtmVo">
    	SELECT X.*,Y.*
		  FROM(
		SELECT T.dwSeq,                                  
				T.userId,                                                                
				T.wiPoint,                               
				T.dwPs,                                 
				TO_CHAR(T.dwReqday,'YYYY-MM-DD') dwReqday,                             
				TO_CHAR(T.dwGetday,'YYYY-MM-DD') dwGetday,                                   
				T.rnum AS no                             
		  FROM(                                          
			SELECT dw.*                                  
				  ,ROW_NUMBER() OVER(ORDER BY dwReqday desc ) AS rnum       
			  FROM dw_record dw
		  )T
		  WHERE rnum BETWEEN (#{page_size} * (#{page_num}-1)+1) 
		    AND (#{page_size} * (#{page_num}-1)+#{page_size})
		)X    
		NATURAL JOIN
		(
		  SELECT COUNT(*) AS total_cnt   
		    FROM dw_record
		)Y
		WHERE dwPs=0
    	AND wiPoint IS NOT NULL	
    </select>
    
    <!-- 관리자 입출금 요청 전체 조회 -->
    <select id="adReqDeWiAll" resultType="AtmVo">
	    SELECT X.*,Y.*
		  FROM(
		SELECT T.dwSeq,                                  
				T.userId,                                  
				T.dePoint,                              
				T.wiPoint,                               
				T.dwPs,                                 
				TO_CHAR(T.dwReqday,'YYYY-MM-DD') dwReqday,                             
				TO_CHAR(T.dwGetday,'YYYY-MM-DD') dwGetday,                                   
				T.rnum AS no                             
		  FROM(                                          
			SELECT dw.*                                  
				  ,ROW_NUMBER() OVER(ORDER BY dwReqday desc ) AS rnum       
			  FROM dw_record dw
		  )T
		  WHERE rnum BETWEEN (#{page_size} * (#{page_num}-1)+1) 
		    AND (#{page_size} * (#{page_num}-1)+#{page_size})
		)X    
		NATURAL JOIN
		(
		  SELECT COUNT(*) AS total_cnt   
		    FROM dw_record
		)Y
		WHERE dwPs=0     
    </select>
    
    <!-- 관리자 입금 확인 전체 조회 -->
    <select id="adPsDeAll" resultType="AtmVo">
	   SELECT X.*,Y.*
		  FROM(
		SELECT T.dwSeq,                                  
				T.userId,                                  
				T.dePoint,                                                             
				T.dwPs,                                 
				TO_CHAR(T.dwReqday,'YYYY-MM-DD') dwReqday,                             
				TO_CHAR(T.dwGetday,'YYYY-MM-DD') dwGetday,                                   
				T.rnum AS no                             
		  FROM(                                          
			SELECT dw.*                                  
				  ,ROW_NUMBER() OVER(ORDER BY dwReqday desc ) AS rnum       
			  FROM dw_record dw
		  )T
		  WHERE rnum BETWEEN (#{page_size} * (#{page_num}-1)+1) 
		    AND (#{page_size} * (#{page_num}-1)+#{page_size})
		)X    
		NATURAL JOIN
		(
		  SELECT COUNT(*) AS total_cnt   
		    FROM dw_record
		)Y
    	WHERE dwPs=1
    	AND dePoint IS NOT NULL
    </select>
    
     <!-- 관리자 출금 확인 전체 조회 -->
    <select id="adPsWiAll" resultType="AtmVo">
	    SELECT X.*,Y.*
		  FROM(
			SELECT T.dwSeq,                                  
					T.userId,                                  
					T.wiPoint,                                                             
					T.dwPs,                                 
					TO_CHAR(T.dwReqday,'YYYY-MM-DD') dwReqday,                             
					TO_CHAR(T.dwGetday,'YYYY-MM-DD') dwGetday,                                   
					T.rnum AS no                             
			  FROM(                                          
				SELECT dw.*                                  
					  ,ROW_NUMBER() OVER(ORDER BY dwReqday desc ) AS rnum       
				  FROM dw_record dw
			  )T
			  WHERE rnum BETWEEN (#{page_size} * (#{page_num}-1)+1) 
			    AND (#{page_size} * (#{page_num}-1)+#{page_size})
			)X    
			NATURAL JOIN
			(
			  SELECT COUNT(*) AS total_cnt   
			    FROM dw_record
			)Y
    		WHERE dwPs=1
    		AND wiPoint IS NOT NULL
    </select>
    
    <!-- 관리자 입출금 확인 전체 조회 -->
    <select id="adPsDeWiAll" resultType="AtmVo">
	    SELECT X.*,Y.*
		  FROM(
			SELECT T.dwSeq,                                  
					T.userId,                                  
					T.dePoint,                              
					T.wiPoint,                               
					T.dwPs,                                 
					TO_CHAR(T.dwReqday,'YYYY-MM-DD') dwReqday,                             
					TO_CHAR(T.dwGetday,'YYYY-MM-DD') dwGetday,                                   
					T.rnum AS no                             
			  FROM(                                          
				SELECT dw.*                                  
					  ,ROW_NUMBER() OVER(ORDER BY dwReqday desc ) AS rnum       
				  FROM dw_record dw
			  )T
			  WHERE rnum BETWEEN (#{page_size} * (#{page_num}-1)+1) 
			    AND (#{page_size} * (#{page_num}-1)+#{page_size})
			)X    
			NATURAL JOIN
			(
			  SELECT COUNT(*) AS total_cnt   
			    FROM dw_record
			)Y
	     WHERE dwPs=1
    </select>
    
    
    <!-- 고객 입금 요청 전체 조회 -->
    <select id="cusReqDeAll" resultType="AtmVo">
	    SELECT X.*,Y.*
		  FROM(
			SELECT T.dwSeq,                                  
					T.userId,                                  
					T.dePoint,                                                             
					T.dwPs,                                 
					TO_CHAR(T.dwReqday,'YYYY-MM-DD') dwReqday,                             
					TO_CHAR(T.dwGetday,'YYYY-MM-DD') dwGetday,                                   
					T.rnum AS no                             
			  FROM(                                          
				SELECT dw.*                                  
					  ,ROW_NUMBER() OVER(ORDER BY dwReqday desc ) AS rnum       
				  FROM dw_record dw
			  )T
			  WHERE rnum BETWEEN (#{page_size} * (#{page_num}-1)+1) 
			    AND (#{page_size} * (#{page_num}-1)+#{page_size})
			)X    
			NATURAL JOIN
			(
			  SELECT COUNT(*) AS total_cnt   
			    FROM dw_record
			)Y
	     WHERE userId = #{userId} <!-- To do -->
	     AND dePoint IS NOT NULL
	     AND dwPs=0	       
    </select>
    
     <!-- 고객 출금 요청 전체 조회 -->
    <select id="cusReqWiAll" resultType="AtmVo">
	    SELECT X.*,Y.*
		  FROM(
			SELECT T.dwSeq,                                  
					T.userId,                                                                
					T.wiPoint,                               
					T.dwPs,                                 
					TO_CHAR(T.dwReqday,'YYYY-MM-DD') dwReqday,                             
					TO_CHAR(T.dwGetday,'YYYY-MM-DD') dwGetday,                                   
					T.rnum AS no                             
			  FROM(                                          
				SELECT dw.*                                  
					  ,ROW_NUMBER() OVER(ORDER BY dwReqday desc ) AS rnum       
				  FROM dw_record dw
			  )T
			  WHERE rnum BETWEEN (#{page_size} * (#{page_num}-1)+1) 
			    AND (#{page_size} * (#{page_num}-1)+#{page_size})
			)X    
			NATURAL JOIN
			(
			  SELECT COUNT(*) AS total_cnt   
			    FROM dw_record
			)Y
	     WHERE userId = #{userId}
	     AND wiPoint IS NOT NULL
	     AND dwPs=0	       
    </select>
    
    <!-- 고객 입금 완료 전체 조회 -->
    <select id="cusPsDeAll" resultType="AtmVo">
	    SELECT X.*,Y.*
		  FROM(
			SELECT T.dwSeq,                                  
					T.userId,                                  
					T.dePoint,                                                            
					T.dwPs,                                 
					TO_CHAR(T.dwReqday,'YYYY-MM-DD') dwReqday,                             
					TO_CHAR(T.dwGetday,'YYYY-MM-DD') dwGetday,                                   
					T.rnum AS no                             
			  FROM(                                          
				SELECT dw.*                                  
					  ,ROW_NUMBER() OVER(ORDER BY dwReqday desc ) AS rnum       
				  FROM dw_record dw
			  )T
			  WHERE rnum BETWEEN (#{page_size} * (#{page_num}-1)+1) 
			    AND (#{page_size} * (#{page_num}-1)+#{page_size})
			)X    
			NATURAL JOIN
			(
			  SELECT COUNT(*) AS total_cnt   
			    FROM dw_record
			)Y
	     WHERE userId = #{userId}
	     AND dePoint IS NOT NULL
	     AND dwPs=1	       
    </select>
    
    
    <!-- 고객 출금 완료 전체 조회 -->
    <select id="cusPsWiAll" resultType="AtmVo">
	    SELECT X.*,Y.*
		  FROM(
			SELECT T.dwSeq,                                  
					T.userId,                                                               
					T.wiPoint,                               
					T.dwPs,                                 
					TO_CHAR(T.dwReqday,'YYYY-MM-DD') dwReqday,                             
					TO_CHAR(T.dwGetday,'YYYY-MM-DD') dwGetday,                                   
					T.rnum AS no                             
			  FROM(                                          
				SELECT dw.*                                  
					  ,ROW_NUMBER() OVER(ORDER BY dwReqday desc ) AS rnum       
				  FROM dw_record dw
			  )T
			  WHERE rnum BETWEEN (#{page_size} * (#{page_num}-1)+1) 
			    AND (#{page_size} * (#{page_num}-1)+#{page_size})
			)X    
			NATURAL JOIN
			(
			  SELECT COUNT(*) AS total_cnt   
			    FROM dw_record
			)Y
	     WHERE userId = #{userId}
	     AND wiPoint IS NOT NULL
	     AND dwPs=1	       
    </select>
    
    <!-- 고객 입금 요청,완료 전체 조회 -->
    <select id="cusReqPsDeAll" resultType="AtmVo">
	    SELECT X.*,Y.*
		  FROM(
			SELECT T.dwSeq,                                  
					T.userId,                                  
					T.dePoint,                                                             
					T.dwPs,                                 
					TO_CHAR(T.dwReqday,'YYYY-MM-DD') dwReqday,                             
					TO_CHAR(T.dwGetday,'YYYY-MM-DD') dwGetday,                                   
					T.rnum AS no                             
			  FROM(                                          
				SELECT dw.*                                  
					  ,ROW_NUMBER() OVER(ORDER BY dwReqday desc ) AS rnum       
				  FROM dw_record dw
			  )T
			  WHERE rnum BETWEEN (#{page_size} * (#{page_num}-1)+1) 
			    AND (#{page_size} * (#{page_num}-1)+#{page_size})
			)X    
			NATURAL JOIN
			(
			  SELECT COUNT(*) AS total_cnt   
			    FROM dw_record
			)Y
	     WHERE userId = #{userId}
	     AND dePoint IS NOT NULL	       
    </select>
    
    <!-- 고객 출금 요청,완료 전체 조회 -->
    <select id="cusReqPsWiAll" resultType="AtmVo">
	    SELECT X.*,Y.*
		  FROM(
			SELECT T.dwSeq,                                  
					T.userId,                                                                
					T.wiPoint,                               
					T.dwPs,                                 
					TO_CHAR(T.dwReqday,'YYYY-MM-DD') dwReqday,                             
					TO_CHAR(T.dwGetday,'YYYY-MM-DD') dwGetday,                                   
					T.rnum AS no                             
			  FROM(                                          
				SELECT dw.*                                  
					  ,ROW_NUMBER() OVER(ORDER BY dwReqday desc ) AS rnum       
				  FROM dw_record dw
			  )T
			  WHERE rnum BETWEEN (#{page_size} * (#{page_num}-1)+1) 
			    AND (#{page_size} * (#{page_num}-1)+#{page_size})
			)X    
			NATURAL JOIN
			(
			  SELECT COUNT(*) AS total_cnt   
			    FROM dw_record
			)Y
	     WHERE userId = #{userId}
	     AND wiPoint IS NOT NULL	       
    </select>
    
         <!-- 관리자 입금 요청 확인 처리 -->
    <update id="adReqDeGet" parameterType="AtmVo">
    	UPDATE dw_record          
	        SET dwPS  = 1           
	       ,dwGetday  = SYSDATE
	    WHERE userId = #{userId}
	      AND dwPs = 0
	      AND dwSeq = #{dwSeq}
	      AND dePoint IS NOT NULL        
    </update>
    
    <!-- 관리자 출금 요청 확인 처리 -->
    <update id="adReqWiGet" parameterType="AtmVo">
	    UPDATE dw_record          
	        SET dwPS  = 1           
	       ,dwGetday  = SYSDATE
	    WHERE userId = #{userId}
	      AND dwPs = 0
	      AND dwSeq = #{dwSeq}
	      AND wiPoint IS NOT NULL	       
    </update>
    
     <!-- 관리자 입금 처리 -->
    <update id="adDeGet" parameterType="AtmVo">
    	UPDATE to_users          
	        SET USERPOINT = USERPOINT + #{dePoint}           
	    WHERE userId = #{userId}
    </update>
    
    <!-- 관리자 출금 처리 -->
    <update id="adWiGet" parameterType="AtmVo">
	    UPDATE to_users          
	        SET USERPOINT = USERPOINT - #{wiPoint}           
	    WHERE userId = #{userId}       
    </update>
	
	<!--종합 입금 요청 수정 -->
	<update id="Deupdate"  parameterType="AtmVo" >
		UPDATE dw_record          
	        SET dePoint = #{dePoint}           
	       ,dwReqday  = SYSDATE
	    WHERE userId = #{userId}
	      AND dwPs = 0
	      AND dwSeq = #{dwSeq}          
	</update>
	
	<!-- 종합 출금 요청 수정 -->
	<update id="Wiupdate"  parameterType="AtmVo" >
		 UPDATE dw_record          
	        SET wiPoint = #{wiPoint}           
	       ,dwReqday  = SYSDATE
	    WHERE userId = #{userId}
	      AND dwPs = 0
	      AND dwSeq = #{dwSeq}            
	</update>
	
	<!-- 종합 단건 삭제 -->
	<delete id="delete"  parameterType="AtmVo"  >
		DELETE FROM HR_USERS 
		WHERE userId = #{userId}
		  AND dwSeq = #{dwSeq}
	</delete>
	
	<!-- 종합 단건 조회 -->
	<select id="get" 
	  parameterType="com.sist.totoro.domain.AtmVo"
	  resultType="com.sist.totoro.domain.AtmVo"	  >
	 SELECT                                    
	     <include refid="allColumns"/>                       
	 FROM dw_record                             
	 WHERE userId = #{userId}
	   AND dwSeq = #{dwSeq}
	</select>
	
	<!--요청 등록 -->
	<insert id="add"  parameterType="AtmVo" >
		 INSERT INTO dw_record (
		 	dwSeq,
		 	userId,
		 	dePoint,
		 	wiPoint,
		 	dwPs,
		 	dwReqday,
		 	dwGetday 
		 ) VALUES (
		 	dwSeq.NEXTVAL,
		 	#{userId},
		 	#{dePoint},
		 	#{wiPoint},
		 	0,
		 	sysdate,
		 	#{dwGetday}              
		 )                      	
	</insert>
	
	<select id="getCount" parameterType="String" 
	                      resultType="java.lang.Integer">
		SELECT COUNT(*) CNT 
		  FROM dw_record     
		 WHERE userId LIKE #{userId} ||'%'  
	</select>
	
	
	
	
</mapper>  